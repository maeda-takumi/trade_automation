# kabuステーションAPI：HoldIDが取れないときのルール（代替可否・取得方法・回避策）

> 対象：kabuステーションAPI（`/sendorder` 返済注文・利確/損切）  
> 目的：**HoldID（建玉ID）が取得できず処理が止まる**ときに、  
> - 何を “HoldID” として使うべきか  
> - 別IDで代替できるのか  
> - どう回避設計するのが安全か  
> を整理します。

---

## 1. まず結論：別IDで雑に代替するのは基本NG

返済注文で **建玉指定返済**（`ClosePositions`）を使う場合、`HoldID` は **建玉ID**である必要があります。

- **NG例**
  - 注文番号（OrderID）で代用
  - 約定明細のExecutionIDを「そのまま」無条件に代用
  - 画面表示上の別番号で代用

> 理由：それらは「建玉そのもの」を指すIDではなく、返済指定（どの建玉を返すか）に一致しない可能性が高い。

---

## 2. 公式ルール：HoldIDは「Eから始まる建玉ID」

- `ClosePositions[].HoldID` は **「Eから始まる建玉ID」**（例：`E2026...`）
- 返済対象の指定は **どちらか一方**
  - **返済順**：`ClosePositionOrder`
  - **建玉指定**：`ClosePositions`（HoldIDで指定）
- `ClosePositionOrder` と `ClosePositions` の **同時指定は不可**

---

## 3. HoldID（建玉ID）はどこから取るのが安全？

### 3-1. 推奨：`GET /positions`（残高照会）から取る
実務上は、**残高照会 `/positions` のレスポンスから「Eで始まるID」を取得して `HoldID` に入れる**のが安定です。

> 注意：レスポンスの項目名が `ExecutionID` になっているケースがあり、  
> それが **Eで始まる建玉ID（HoldID相当）**として使われます（株の信用残高照会でよく見られる）。

### 3-2. 重要：/orders のExecutionIDとは混同しない
- `/orders` 側の “ExecutionID” は **約定の識別**寄りの情報になりがちで、
- **返済指定に使うソースは原則 `/positions` 側**と考えるのが安全です。

---

## 4. 「代替できる」パターン：HoldIDを使わない設計

### 4-1. HoldID不要：返済順で一括返済（ClosePositionOrder）
「どの建玉でもいいから、順序ルールで返したい」なら

- `ClosePositionOrder`（返済順）を使う  
- `ClosePositions` を使わない  
→ **HoldIDの取得ができなくても返済注文を組める**

> ただし、返済される建玉が “順序” に依存します。  
> 「この建玉だけを返したい」要件には向きません。

---

## 5. HoldIDが取れないときのよくある原因と対策

### 5-1. そもそも建玉がまだ存在しない／反映待ち
- 約定直後は `/positions` 反映が遅れることがあります
- **短時間のポーリング（リトライ）**で解消しやすい

**対策**
- 約定検知 → `/positions` を 1〜数秒間隔で複数回リトライ  
- タイムアウトしたら「HoldID未確定」扱いで注文を保留

### 5-2. product指定ミス（信用残高を見ていない）
- `/positions?product=2`（信用）など、**信用の残高**を取得しているか確認
- もしくは `product=0`（すべて）で検証

### 5-3. 同一銘柄で複数建玉（複数行）になっている
- 同じ銘柄でも、約定単位・建玉単位で複数行になることがあります

**対策**
- `/positions` の行を以下で絞る
  - `Symbol`（銘柄）
  - `Side`（ロング/ショート）
  - `MarginTradeType`（制度/一般 等）
  - 必要なら `Price`（建値）や `LeavesQty` など
- 部分返済なら、対象行ごとに `ClosePositions[].Qty` を割り当てる

### 5-4. Side（売買区分）の取り違えで返済が通らない
- ロング（買建）を返す → **返済注文は売（Side=1）**
- ショート（売建）を返す → **返済注文は買（Side=2）**

---

## 6. 実装のおすすめフロー（止まらない設計）

### A. 建玉を厳密に指定して返済したい（HoldID必須）
1. 新規建て注文 → 約定確認
2. `/positions` をポーリングして建玉が現れるのを待つ
3. 条件一致する行（銘柄/Side/信用区分）を特定
4. その行の **Eで始まるID（HoldID相当）** を取り出す
5. `ClosePositions` に入れて返済発注（利確=指値 / 損切=逆指値）

### B. とにかく返済できれば良い（HoldIDレス）
- `ClosePositionOrder` を使い、返済順で決済
- 「片方約定したらもう片方取消」などOCO相当の運用は自前で実装

---

## 7. すぐ確認できるチェックリスト

- [ ] `/positions` を取得している（信用建玉が見えている）
- [ ] `/positions` 取得時の `product` が信用（または全て）になっている
- [ ] レスポンス内に **Eで始まるID** が存在する
- [ ] 返済注文はロング/ショートに合わせて `Side` を正しくしている
- [ ] `ClosePositionOrder` と `ClosePositions` を同時に指定していない
- [ ] 反映待ちの可能性を考慮し、ポーリングや再試行を入れている

---

## 8. 追記：困ったらここだけ貼ってもらえれば切り分け可能
次のどちらか（個人情報/口座番号等は伏せてOK）
- `/positions` の該当銘柄の行（1〜3行）
- 返済発注JSON（ClosePositions/ClosePositionOrder 周り）

これだけで「どの項目をHoldIDとして採るべきか」「なぜ0件なのか」「Sideやproductのミスか」を即判定できます。
